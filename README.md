# 月华
《月华》是一款以**月相变化**为核心机制，结合了牌组构建、竞速、跑分、肉鸽（Rogue-like）等多种机制以及**中国传统元素**的单机游戏，[详情]()（网站建设中）

目前《月华》处于早期开发和概念阶段，预计在3月初会发布第一版初始demo

本仓库是《月华》的后端开发仓库，旨在记录我的独立开发过程

## 服务器架构

本项目使用微服务架构，结合GO语言与C++，在Ubuntu环境下实现高并发支持和状态实时更新，集成注册中心，自动注册微服务元数据

* **Go 服务**：主服务器，用于处理用户请求和管理业务逻辑
    * 主程序：负责启动服务和初始化
        * 使用Go的标准库来搭建Web服务（net/http，gin，echo等框架可以选择）
        * 提供RESTful API来与前端和C++服务交互
        * 使用goroutine和channel来处理并发任务
    * 数据库管理：使用gorm库来与MySQL进行交互
    * 缓存管理：使用go-redis库来实现与Redis的连接
    * 高性能服务：如果需要计算密集型任务，Go通过调用C++的接口来将计算任务交给C++模块处理
    * API网关：负责对外暴露接口，并与后端各个服务进行路由转发
* **C++服务**：计算密集型的服务，通过gRPC或HTTP与Go服务通信
    * 用C++编写一些计算密集型的任务（如数据处理、图像处理等）
    * C++与Go通过gRPC进行通信：
        * 定义Protobuf接口，Go与C++服务分别实现该接口
        * 通过gRPC请求来进行跨语言的数据传递和函数调用
* API网关：负责前后端之间的请求路由，可以使用Nginx或者使用Go自定义开发
    * 通过RESTful API（或者gRPC）来设计后端的各个接口。
    * 例如：
        * 用户登录（POST /login）
        * 获取商品信息（GET /products）
        * 创建订单（POST /orders）
        * 获取用户订单（GET /orders/{userId}）
* 数据库：
    * MySQL：关系型数据存储
        * 设计数据表来存储用户信息、商品信息、订单信息等。
        * 需要用到gorm（Go的ORM框架）来简化数据库操作。
    * Redis：缓存
        * 用作缓存，提升数据访问的效率。例如可以缓存热门商品、用户信息等。
    * ElasticSearch：日志和数据索引检索
        * 用于商品的全文搜索以及日志的存储和查询。
* 容器化：Docker + Kubernetes（用于扩展和容器化部署）
    * Docker化：
        * 为每个服务（Go服务、C++服务、MySQL、Redis等）创建一个Docker镜像。
        * 使用docker-compose来管理多个容器的运行。
    * Kubernetes：
        * 部署在Kubernetes上，确保服务的高可用和可伸缩性。
        * 使用Kubernetes的Deployment和Service来管理不同服务的部署和负载均衡。
    * CI/CD：
        * 配置GitHub Actions或GitLab CI来实现自动化部署。
        * 在每次代码提交时自动执行测试、构建镜像并推送到Docker Registry。
* 消息队列：RabbitMQ/Kafka（用于服务之间的异步通信）
* 部署：完整服务迁移上云部署，可选常规服务器部署、云托管、Fass等方式，这里不做任何限制
* 测试：有比较良好的编码规范严格按照技术编码规范进行编码，与此同时，针对业务类需求编写了相对完善的单元测试用例，选取合适的单元测试框架
* 编码：侧重服务端实现，会提前定义好各个功能对应的接口（接口定义推荐使用Protobuf，但不做限制），按说明实现接口即可在客户端中看到运行效果
    * 服务端最基本的结构只需要服务端程序和数据库即可，服务端程序连接数据库，响应客户端请求完成对应功能。同时需要根据功能，设计合理的数据模型，并创建对应的数据表，其中日志文件等可以保存到本地

## 服务器功能
* 用户管理模块：
    * 注册与登录：用户注册、登录功能，支持玩家的身份认证，可以使用JWT进行令牌验证。（steam SDK？）
    * 玩家状态管理：管理玩家的月光值、卡牌状态、地图进度等。
    * 登录认证
        * 可以使用第三方现成的登录验证框架（CasBin、Satoken等），对请求进行身份验证
        * 可配置的认证白名单，对于某些不需要认证的接口或路径，允许直接访问
        * 可配置的黑名单，对于某些异常的用户，直接进行封禁处理（可选）
    * 权限认证（高级）
        * 根据用户的角色和权限，对请求进行授权检查，确保只有具有相应权限的用户能够访问特定的服务或接口。
        * 支持正则表达模式的权限匹配
        * 支持动态更新用户权限信息，当用户权限发生变化时，权限校验能够实时生效。
* 游戏引擎模块：
    * 卡牌机制引擎：根据游戏灵感中的卡牌机制（如“同相”、“反相”、“月相周期”）计算并更新玩家的状态。
    * 地图与格子管理：管理玩家的竞速地图，计算玩家的进度、归属权、月光消耗等。
    * 事件机制：实现全局事件，如“月光风暴”、“干扰区”等，根据游戏进度动态触发，并通知前端。
* PVP与PVE机制：
    * PVP机制：管理玩家之间的对抗与月光消耗，判断玩家是否有资格前进。
    * PVE机制：根据章节的主题与BOSS设计，控制剧情的推进，利用月相牌解锁剧情。
* 游戏存档与重启：
    * 保存游戏的进度和玩家状态，支持断线重连和游戏重启。
    * 存储玩家的卡牌、月光进度、地图状态等数据。
* 推送与通知：
    * 后端通过WebSocket推送实时游戏状态更新给前端。
* 日志记录与监控
  * 对服务的运行状态和请求处理过程进行详细的日志记录，方便故障排查和性能分析。
  * 提供实时监控功能，能够及时发现和解决系统中的问题。
* 容错机制
  * 该服务应具备一定的容错能力，当出现部分下游服务不可用或网络故障时，能够自动切换到备用服务或进行降级处理。
  * 保证下游在异常情况下，系统的整体可用性不会受太大影响，且核心服务可用。
  * 服务应该具有一定的流量兜底措施，在服务流量激增时，应该给予一定的限流措施。

## 开发进度
| 日期 | 当前进度 |
| ------- | ------- |
| 2025.2.15 | 创建了前后端仓库，完成了基本的框架架构设计 |
| 2025.2.16 | 目前正在完善基本玩法设计，预计1-2天即可完成，随后会马上转向pve玩法的开发 |